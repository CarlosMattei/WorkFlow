<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Freelancers</title>
    <link rel="stylesheet" href="/css/proposals/proposals.css">
</head>

<body>
    <div class="preloader-container" id="preloader">
        <div class="loader">
          <img src="/assets/vetors/loader.gif" alt="" style="width: 150px; height: 100%;">
      </div>
      </div>
      <script src="/js/preloader.js"></script>
    <section class="section2">
        <div class="container-filter h-full  bg-background">
            <div class="filtro h-full">
                <h2 class="text-2xl mg-0">Filtrar</h2>
                <div class="container-area mg-1">
                    <label for="area" class="mg-0">Área</label>
                    <select class="sm" class="mg-0" name="area" id="area">
                        <option value="Todos">Todos</option>
                        <option value="Design">Design</option>
                        <option value="UI design">UI Design</option>
                        <option value="3D design">3D Design</option>
                        <option value="Canva design">Canva design</option>
                        <option value="UX">UX</option>
                        <option value="Web design">Web design</option>
                        <option value="Interior design">interior design</option>
                        <option value="Poster design">Poster Design</option>
                    </select>
                </div>
                <div class="container-periodo mg-1">
                    <label for="periodo" class="mg-0">Periodo</label>
                    <select class="mg-0 sm" name="periodo" id="periodo">
                        <option value="indefinido">Indefinido</option>
                        <option value="hoje">hoje</option>
                        <option value="ultimaSemana">Ultima semana</option>
                        <option value="ultimoMes">Ultimo mês</option>
                    </select>
                </div>
                <div class="container-preco mg-1">
                    <div class="min">
                        <label for="min" class="mg-0">Preço Min.</label>
                        <input class="form-control sm" type="text" name="min" id="precomin">
                    </div>
                    <div class="max">
                        <label for="max" class="mg-0">Preço Max.</label>
                        <input type="text" class="form-control sm" name="max" id="precomax">
                    </div>
                </div>
                <div class="container-botao">
                    <button type="submit" id="btnFiltrar">Filtrar</button>
                </div>
            </div>
        </div>

        <div class="filterMobileButton"  id="btnFiltrarModal">
            <button class="btn btn-purple flex h-full pd-y-4 justify-center items-center rounded-full" style="height: none;" id="btnFiltrarModal">
                <ion-icon name="funnel-outline" style="font-size: 25px;"></ion-icon>
            </button>
        </div>

        <dialog id="filterMobileModal" class="filterMobileModal bg-gray-100 pd-3 border border-solid rounded-lg border-gray">
            <div
            class="top flex flex-row flex items-center pd-b-2 border-b border-t-0 border-r-0 border-l-0 mg-b-2 border-solid border-gray">
            <h1 class="text-xl flex flex-1 mg-0 text-white">Filtrar</h1>
            <button id="close" class="closemodal" style="background-color: var(--background); border: 0px;"><ion-icon
                    name="close-outline" size="large" style="color: var(--white);"></ion-icon></button>
        </div>
        <div class="container-area mg-1">
            <label for="area" class="mg-0">Área</label>
            <select class="sm" class="mg-0" name="area" id="area">
                <option value="Todos">Todos</option>
                <option value="Design">Design</option>
                <option value="UI design">UI Design</option>
                <option value="3D design">3D Design</option>
                <option value="Canva design">Canva design</option>
                <option value="UX">UX</option>
                <option value="Web design">Web design</option>
                <option value="Interior design">interior design</option>
                <option value="Poster design">Poster Design</option>
            </select>
        </div>
        <div class="container-periodo mg-1">
            <label for="periodo" class="mg-0">Periodo</label>
            <select class="mg-0 sm" name="periodo" id="periodo">
                <option value="indefinido">Indefinido</option>
                <option value="hoje">hoje</option>
                <option value="ultimaSemana">Ultima semana</option>
                <option value="ultimoMes">Ultimo mês</option>
            </select>
        </div>
        <div class="container-preco mg-1">
            <div class="min">
                <label for="min" class="mg-0">Preço Min.</label>
                <input class="form-control sm" type="text" name="min" id="precomin">
            </div>
            <div class="max">
                <label for="max" class="mg-0">Preço Max.</label>
                <input type="text" class="form-control sm" name="max" id="precomax">
            </div>
        </div>
        <div class="container-botao">
            <button type="submit" id="btnFiltrar">Filtrar</button>
        </div>
        </dialog>
        <div id="FilterModalOverlay" class="FilterModalOverlay"></div>

        <div class="propostas w-full pd-3" style="height: calc(100vh - 80px - 30px); overflow: auto;">
        </div>
    </section>

    <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, push, set, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAAtfGyZc3SLzdK10zdq-ALyTyIs1s4qwQ",
        authDomain: "workflow-da28d.firebaseapp.com",
        projectId: "workflow-da28d",
        storageBucket: "workflow-da28d.appspot.com",
        messagingSenderId: "939828605253",
        appId: "1:939828605253:web:0a286fe00f1c29ba614e2c",
        measurementId: "G-3LXB7BR5M1"
    };

    let app;
    if (!getApps().length) {
        app = initializeApp(firebaseConfig);
    } else {
        app = getApps()[0];
    }

    const db = getDatabase(app);
    const auth = getAuth(app);

    const propostasContainer = document.querySelector('.section2 .propostas');
    const btnFiltrar = document.getElementById('btnFiltrar');

    let propostas = [];
    let currentUserId = null;
    let currentUserName = '';
    let currentUserPhoto = '';
    let currentUserTag = '';
    let currentUserTipo = "";   
    let countdownIntervals = {};

    const modalCandidatarHtml = `
    <div id="modalCandidatar" class="modal" style="display:none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: (0, 0, 0, 0.9); justify-content: center; align-items: center;">
        <div class="modal-content pd-3 bg-gray-75 border border-solid text-white border-gray-25 rounded-lg" style="margin: auto; width: 80%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
            <span class="modal-close" id="closeCandidatarModal" style="color: var(--white); float: right; font-size: 28px; cursor: pointer;">&times;</span>
            <h2 style="color: var(--primary); text-align: center; margin-bottom: 20px;">Enviar Candidatura</h2>
            <p class="text text-white text-md">Escreva uma breve descrição sobre por que você é o melhor candidato para esta proposta:</p>
            <textarea class="form-control sm"  id="descricaoCandidatura" rows="8" placeholder="Sua mensagem para o contratante..." style="padding: 10px; margin-bottom: 20px; resize: vertical;"></textarea>
            <button id="btnConfirmarCandidatura" class="btn btn-primary">Confirmar Candidatura</button>
        </div>
    </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalCandidatarHtml);

    const modalCandidatar = document.getElementById('modalCandidatar');
    const closeCandidatarModal = document.getElementById('closeCandidatarModal');
    const descricaoCandidaturaInput = document.getElementById('descricaoCandidatura');
    const btnConfirmarCandidatura = document.getElementById('btnConfirmarCandidatura');

    let currentPropostaId = null;

    function formatarData(isoString) {
        const data = new Date(isoString);
        return isNaN(data)
            ? "Data inválida"
            : data.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
    }

    function formatarTempo(ms) {
        if (ms <= 0) return "Expirado";

        const segundos = Math.floor(ms / 1000);
        const minutos = Math.floor(segundos / 60);
        const horas = Math.floor(minutos / 60);
        const dias = Math.floor(horas / 24);

        const s = segundos % 60;
        const m = minutos % 60;
        const h = horas % 24;

        const partes = [];
        if (dias > 0) partes.push(`${dias}d`);
        if (h > 0) partes.push(`${h}h`);
        if (m > 0) partes.push(`${m}m`);
        if (s > 0 && dias === 0 && h === 0 && m === 0) partes.push(`${s}s`);

        if (partes.length === 0) return "Menos de 1s";
        return partes.join(' ');
    }

    function renderizarPropostas(propostasFiltradas) {
        const auth = getAuth();
        const user = auth.currentUser;
        const userId = user ? user.uid : null;

        propostasContainer.innerHTML = '';
        Object.values(countdownIntervals).forEach(clearInterval);
        countdownIntervals = {};

        if (propostasFiltradas.length === 0) {
            propostasContainer.innerHTML = '<p>Nenhuma proposta encontrada com os filtros selecionados.</p>';
            return;
        }

        const agora = new Date();

        propostasFiltradas.forEach(p => {
            const dataExpiracao = p.dataExpiracao ? new Date(p.dataExpiracao) : null;
            if (dataExpiracao && agora > dataExpiracao) return;

            const tagsHtml = Array.isArray(p.tags)
                ? p.tags.map(tag => `<span class="tag">${tag}</span>`).join('')
                : '';

            let iconesDeContatoHtml = '';
            if (p.meiosDeContato) {
                const iconMap = {
                    chat: 'chatbubbles-outline',
                    whatsapp: 'logo-whatsapp',
                    email: 'mail-outline',
                    github: 'logo-github',
                    linkedin: 'logo-linkedin',
                    outro: 'ellipsis-horizontal-outline'
                };

                iconesDeContatoHtml = Object.entries(p.meiosDeContato)
                    .filter(([, value]) => value)
                    .map(([key]) => {
                        const iconName = iconMap[key] || 'ellipsis-horizontal-outline';
                        const contatoDetalhe = p.contatosDetalhes?.[key] || '';
                        return `<ion-icon name="${iconName}" class="contact-icon" data-contato="${contatoDetalhe}" title="${key}"></ion-icon>`;
                    })
                    .join('');
            }

            const fotoUrl = p.fotoAutorUrl || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
            const nomeAutor = p.nomeAutor || 'Nome não informado';

            const wrapper = document.createElement('div');
            const card = document.createElement('div');
            card.classList.add('proposta-card');
            card.dataset.propostaId = p.id;

            
            const podeCandidatar =
                (p.autorId !== userId) &&
                (currentUserTipo !== "contratante");

            card.innerHTML = `
                <div class="card-header">
                    <div class="card-title">
                        <h3>${p.titulo || 'Sem título'}</h3>
                        <div class="card-price">R$${p.precoMin || '-'} - R$${p.precoMax || '-'}</div>
                    </div>
                    <p class="card-date">Criado em ${formatarData(p.datacriacao)}</p>
                    <div class="duration-info">
                        <span id="countdown-${p.id}"></span>
                    </div>
                </div>

                <div class="card-body">
                    <p class="card-description">${p.descricao || 'Nenhuma descrição fornecida.'}</p>
                    <div class="card-tags">${tagsHtml}</div>
                </div>

                <div class="card-footer">
                    <div class="client-info">
                        <a href="/perfil?id=${p.autorId}" class="profile-link">
                            <img class="profilePic" src="${fotoUrl}" alt="${nomeAutor}">
                            <span class="client-name">${nomeAutor}</span>
                        </a>
                    </div>

                    <div class="proposal-details">
                        <div class="contact-icons">
                            ${iconesDeContatoHtml}
                        </div>
                    </div>

                    ${podeCandidatar ? `<button class="enviar">Se candidatar</button>` : ""}
                </div>
            `;

            wrapper.appendChild(card);
            propostasContainer.appendChild(wrapper);

            if (dataExpiracao) {
                const countdownEl = document.getElementById(`countdown-${p.id}`);
                const updateCountdown = () => {
                    const tempoRestante = dataExpiracao.getTime() - new Date().getTime();
                    if (tempoRestante <= 0) {
                        countdownEl.textContent = "Expirado";
                        clearInterval(countdownIntervals[p.id]);
                        card.parentElement.remove();
                    } else {
                        countdownEl.textContent = formatarTempo(tempoRestante) + ' para expirar';
                    }
                };

                updateCountdown();
                countdownIntervals[p.id] = setInterval(updateCountdown, 1000);
            } else {
                document.getElementById(`countdown-${p.id}`).textContent = 'Tempo Indefinido';
            }
        });

        adicionarEventoBotaoCandidatarse();
        adicionarEventosDeContato();
    }

    function adicionarEventosDeContato() {
        document.querySelectorAll('.contact-icon').forEach(icon => {
            const contato = icon.dataset.contato;
            if (contato) {
                const parent = icon.parentElement;

                const tooltip = document.createElement('span');
                tooltip.classList.add('tooltip');
                tooltip.textContent = contato;
                parent.appendChild(tooltip);

                icon.addEventListener('mouseover', () => {
                    tooltip.style.visibility = 'visible';
                    tooltip.style.opacity = '1';
                });

                icon.addEventListener('mouseout', () => {
                    tooltip.style.visibility = 'hidden';
                    tooltip.style.opacity = '0';
                });

                icon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (tooltip.style.visibility === 'visible') {
                        tooltip.style.visibility = 'hidden';
                        tooltip.style.opacity = '0';
                    } else {
                        document.querySelectorAll('.tooltip').forEach(t => {
                            t.style.visibility = 'hidden';
                            t.style.opacity = '0';
                        });
                        tooltip.style.visibility = 'visible';
                        tooltip.style.opacity = '1';
                    }
                });
            }
        });

        document.addEventListener('click', (e) => {
            if (!e.target.classList.contains('contact-icon')) {
                document.querySelectorAll('.tooltip').forEach(t => {
                    t.style.visibility = 'hidden';
                    t.style.opacity = '0';
                });
            }
        });
    }

    function adicionarEventoBotaoCandidatarse() {
        document.querySelectorAll('.enviar').forEach(botao => {
            botao.removeEventListener('click', handleCandidatarClick);
            botao.addEventListener('click', handleCandidatarClick);
        });
    }

    async function handleCandidatarClick(event) {
        if (!currentUserId) {
            alert('Você precisa estar logado para se candidatar a uma proposta!');
            return;
        }

        const card = event.target.closest('.proposta-card');
        if (!card) return;

        const propostaId = card.dataset.propostaId;
        currentPropostaId = propostaId;

        const candidaturaRef = ref(db, `Candidaturas/${propostaId}/${currentUserId}`);
        const candidaturaSnap = await get(candidaturaRef);

        if (candidaturaSnap.exists()) {
            alert('Você já se candidatou para esta proposta!');
            return;
        }

        modalCandidatar.style.display = 'flex';
        descricaoCandidaturaInput.value = '';
    }

    closeCandidatarModal.addEventListener('click', () => {
        modalCandidatar.style.display = 'none';
    });

    modalCandidatar.addEventListener('click', (e) => {
        if (e.target === modalCandidatar) {
            modalCandidatar.style.display = 'none';
        }
    });

    btnConfirmarCandidatura.addEventListener('click', async () => {
        const descricao = descricaoCandidaturaInput.value.trim();

        if (!descricao) {
            alert('Por favor, escreva uma descrição para sua candidatura.');
            return;
        }

        if (!currentPropostaId || !currentUserId) {
            alert('Erro: Proposta ou usuário não identificado. Tente novamente.');
            return;
        }

        try {
            const propostaRef = ref(db, `Propostas/${currentPropostaId}`);
            const propostaSnap = await get(propostaRef);
            const propostaData = propostaSnap.val();

            if (!propostaData) {
                alert('A proposta não existe mais.');
                modalCandidatar.style.display = 'none';
                return;
            }

            const candidaturaData = {
                userId: currentUserId,
                nome: currentUserName,
                foto_perfil: currentUserPhoto,
                tag: currentUserTag,
                mensagem: descricao,
                timestamp: Date.now()
            };

            await set(ref(db, `Candidaturas/${currentPropostaId}/${currentUserId}`), candidaturaData);

            alert('Candidatura enviada com sucesso!');
            modalCandidatar.style.display = 'none';

            const cardEnviado = document.querySelector(`.proposta-card[data-proposta-id="${currentPropostaId}"] .enviar`);
            if (cardEnviado) {
                if (!cardEnviado.classList.contains('enviado')) {
                    cardEnviado.classList.add('enviado');
                    const check = document.createElement('span');
                    check.classList.add('checkmark');
                    cardEnviado.textContent = 'Enviado';
                    cardEnviado.appendChild(check);

                    setTimeout(() => {
                        cardEnviado.classList.remove('enviado');
                        check.remove();
                        cardEnviado.textContent = 'Se candidatar';
                    }, 2000);
                }
            }
        } catch (error) {
            console.error("Erro ao enviar candidatura:", error);
            alert('Ocorreu um erro ao enviar sua candidatura. Tente novamente.');
        }
    });

    function filtrarPropostas() {
        const area = document.getElementById('area').value;
        const periodo = document.getElementById('periodo').value;
        const precoMin = parseFloat(document.getElementById('precomin').value) || 0;
        const precoMax = parseFloat(document.getElementById('precomax').value) || Infinity;
        const agora = new Date();

        const propostasFiltradas = propostas.filter(p => {
            const dataCriacao = new Date(p.datacriacao);
            if (isNaN(dataCriacao)) return false;

            const dentroDaArea = (area === "Todos") ? true : Array.isArray(p.tags) && p.tags.includes(area);

            let dentroDoPeriodo = true;
            if (periodo === 'hoje') {
                dentroDoPeriodo = dataCriacao.toDateString() === agora.toDateString();
            } else if (periodo === 'ultimaSemana') {
                const seteDiasAtras = new Date(agora);
                seteDiasAtras.setDate(agora.getDate() - 7);
                dentroDoPeriodo = dataCriacao >= seteDiasAtras;
            } else if (periodo === 'ultimoMes') {
                const trintaDiasAtras = new Date(agora);
                trintaDiasAtras.setDate(agora.getDate() - 30);
                dentroDoPeriodo = dataCriacao >= trintaDiasAtras;
            } else if (periodo === 'indefinido') {
                dentroDoPeriodo = true;
            }

            const precoMinProposta = parseFloat(p.precoMin) || 0;
            const precoMaxProposta = parseFloat(p.precoMax) || 0;
            const dentroDoPreco = precoMinProposta >= precoMin && precoMaxProposta <= precoMax;

            return dentroDaArea && dentroDoPeriodo && dentroDoPreco;
        });

        renderizarPropostas(propostasFiltradas);
    }

    document.addEventListener('DOMContentLoaded', () => {
        btnFiltrar.addEventListener('click', (e) => {
            e.preventDefault();
            filtrarPropostas();
        });

        const searchInput = document.querySelector('.searchbar-input');
        const aplicarFiltroPorTitulo = (busca) => {
            if (!busca) {
                renderizarPropostas(propostas);
                return;
            }
            const filtradas = propostas.filter(p =>
                p.titulo?.toLowerCase().includes(busca.toLowerCase())
            );
            renderizarPropostas(filtradas);
        };

        const params = new URLSearchParams(window.location.search);
        const busca = params.get('busca') || '';
        if (searchInput) {
            searchInput.value = busca;
            if (busca) aplicarFiltroPorTitulo(busca);

            searchInput.addEventListener('input', (e) => {
                aplicarFiltroPorTitulo(e.target.value.trim());
            });
        }
    });

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUserId = user.uid;

            const freelancerSnap = await get(ref(db, `Freelancer/${currentUserId}`));
            
            if (freelancerSnap.exists()) {
                const userData = freelancerSnap.val();
                currentUserName = userData.nome || 'Usuário Anônimo';
                currentUserPhoto = userData.foto_perfil || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
                currentUserTag = userData.tag || 'Freelancer';
                currentUserTipo = "freelancer";     
            } else {

                const contratanteSnap = await get(ref(db, `Contratante/${currentUserId}`));
                if (contratanteSnap.exists()) {
                    currentUserTipo = "contratante"; 
                }

                currentUserName = 'Usuário Logado';
                currentUserPhoto = 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
                currentUserTag = 'Usuário';
            }
        } else {
            currentUserId = null;
            currentUserName = '';
            currentUserPhoto = '';
            currentUserTag = '';
            currentUserTipo = ""; 
        }

        onValue(ref(db, 'Propostas'), (snapshot) => {
            propostas = [];
            snapshot.forEach(childSnap => {
                const propostaData = { id: childSnap.key, ...childSnap.val() };
                propostas.push(propostaData);
            });

            propostas.sort((a, b) => {
                const dataA = new Date(a.datacriacao);
                const dataB = new Date(b.datacriacao);
                return dataB - dataA;
            });

            const params = new URLSearchParams(window.location.search);
            const busca = params.get('busca') || '';
            if (busca) {
                const searchInput = document.querySelector('.searchbar-input');
                if (searchInput) {
                    searchInput.value = busca;
                    const filtradas = propostas.filter(p =>
                        p.titulo?.toLowerCase().includes(busca.toLowerCase())
                    );
                    renderizarPropostas(filtradas);
                } else {
                    renderizarPropostas(propostas);
                }
            } else {
                renderizarPropostas(propostas);
            }
        });
    });
</script>


    <script>
        const buttonOpen = document.getElementById("btnFiltrarModal");
        const modal = document.getElementById("filterMobileModal");
        const overlay = document.getElementById("FilterModalOverlay");
        const buttonClose = document.getElementById("close");

        buttonOpen.addEventListener('click', () => {
            modal.showModal();
            overlay.classList.add('active');
        setTimeout(() => modal.classList.add('open'), 10);
    });

    function closeModal() {
        modal.classList.remove("open");
        modal.classList.add("closing");
        overlay.classList.remove("active");
        setTimeout(() => {
            modal.classList.remove("closing");
            modal.close();
        }, 300);
    }

    buttonClose.onclick = closeModal;
    </script>
</body>